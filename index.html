<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Slashr - Dashboard Consultants</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="data.js"></script>
<style>
  :root {
    --bg: #0f1117;
    --card: #1a1d27;
    --border: #2a2d3a;
    --text: #e4e4e7;
    --text-dim: #8b8d98;
    --accent: #6366f1;
    --accent2: #8b5cf6;
    --green: #22c55e;
    --orange: #f59e0b;
    --red: #ef4444;
    --blue: #3b82f6;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, #1a1d27 0%, #252836 100%);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }
  .header h1 {
    font-size: 22px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .header .subtitle { color: var(--text-dim); font-size: 13px; margin-top: 2px; }
  .filters {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
  }
  .filter-group { display: flex; flex-direction: column; gap: 4px; }
  .filter-group label {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  select, input[type="month"] {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
  }
  select:hover, input[type="month"]:hover { border-color: var(--accent); }
  select:focus, input[type="month"]:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }

  .container { padding: 24px 32px; max-width: 1440px; margin: 0 auto; }

  /* KPI Cards */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .kpi-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }
  .kpi-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .kpi-value { font-size: 28px; font-weight: 700; }
  .kpi-value.accent { color: var(--accent); }
  .kpi-value.green { color: var(--green); }
  .kpi-value.orange { color: var(--orange); }
  .kpi-sub { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

  /* Charts */
  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }
  .chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }
  .chart-card.full { grid-column: 1 / -1; }
  .chart-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: var(--text-dim); }
  .chart-container { position: relative; width: 100%; }
  .chart-container.h300 { height: 300px; }
  .chart-container.h400 { height: 400px; }

  /* Tables */
  .table-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    overflow-x: auto;
  }
  .table-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: var(--text-dim); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    text-align: left; padding: 10px 12px; border-bottom: 2px solid var(--border);
    color: var(--text-dim); font-weight: 600; text-transform: uppercase; font-size: 11px;
    letter-spacing: 0.5px; cursor: pointer; user-select: none; white-space: nowrap;
  }
  th:hover { color: var(--accent); }
  th.sorted-asc::after { content: ' \u25B2'; }
  th.sorted-desc::after { content: ' \u25BC'; }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  tr:hover td { background: rgba(99,102,241,0.05); }
  .mini-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; min-width: 120px; }
  .mini-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .badge-closed { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-open { background: rgba(245,158,11,0.15); color: var(--orange); }

  /* Tabs */
  .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
  .tab-btn {
    padding: 8px 20px; border-radius: 8px; font-size: 13px; font-weight: 600;
    cursor: pointer; background: transparent; color: var(--text-dim);
    border: 1px solid transparent; transition: all 0.15s;
  }
  .tab-btn:hover { color: var(--text); background: rgba(255,255,255,0.05); }
  .tab-btn.active { color: var(--accent); background: rgba(99,102,241,0.1); border-color: var(--accent); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* Clickable rows */
  .clickable-row { cursor: pointer; }
  .clickable-row:hover td { background: rgba(99,102,241,0.12) !important; }

  /* Project detail header */
  .project-detail-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }
  .btn-back {
    background: var(--card);
    color: var(--text-dim);
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn-back:hover { color: var(--text); border-color: var(--accent); }
  .project-detail-header h2 { font-size: 20px; font-weight: 700; }
  .prestations-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .prestations-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-dim); }
  .prestations-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .presta-tag {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(99,102,241,0.08);
    border: 1px solid rgba(99,102,241,0.2);
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 13px;
  }
  .presta-tag .presta-name { font-weight: 600; color: var(--text); }
  .presta-tag .presta-meta { color: var(--text-dim); font-size: 12px; }
  .presta-type {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  @media (max-width: 768px) {
    .charts-grid { grid-template-columns: 1fr; }
    .header { padding: 16px; }
    .container { padding: 16px; }
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>Slashr - Performance Consultants</h1>
    <div class="subtitle">Dashboard analytique - Temps estimes ClickUp</div>
  </div>
  <div class="filters">
    <div class="filter-group">
      <label>Consultant</label>
      <select id="filterUser">
        <option value="">Tous les consultants</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Categorie</label>
      <select id="filterCategory">
        <option value="">Toutes les categories</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Projet</label>
      <select id="filterProject">
        <option value="">Tous les projets</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Du</label>
      <input type="month" id="filterStart">
    </div>
    <div class="filter-group">
      <label>Au</label>
      <input type="month" id="filterEnd">
    </div>
  </div>
</div>

<div class="container">

  <!-- Filter info -->
  <div id="filterInfo" style="display:none;background:#ef444422;border:1px solid #ef4444;color:#fca5a5;padding:12px 20px;border-radius:8px;margin-bottom:16px;font-size:14px;"></div>

  <!-- KPI summary -->
  <div class="kpi-grid" id="kpiGrid"></div>

  <!-- Tabs -->
  <div class="tabs" id="tabBar">
    <button class="tab-btn active" data-tab="overview">Vue d'ensemble</button>
    <button class="tab-btn" data-tab="categories">Categories</button>
    <button class="tab-btn" data-tab="projects">Projets</button>
    <button class="tab-btn" data-tab="timeline">Timeline</button>
    <button class="tab-btn" data-tab="detail">Detail taches</button>
  </div>

  <!-- TAB: Overview -->
  <div id="panel-overview" class="tab-panel active">
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Repartition par categorie (temps estime)</h3>
        <div class="chart-container h300"><canvas id="chartCategories"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Heures estimees par mois</h3>
        <div class="chart-container h300"><canvas id="chartMonthly"></canvas></div>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card full">
        <h3>Categories par mois</h3>
        <div class="chart-container h400"><canvas id="chartCategoryMonthly"></canvas></div>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Repartition par projet (temps estime)</h3>
        <div class="chart-container h300"><canvas id="chartProjects"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Estime vs Tracke par mois</h3>
        <div class="chart-container h300"><canvas id="chartEstVsTracked"></canvas></div>
      </div>
    </div>
  </div>

  <!-- TAB: Categories -->
  <div id="panel-categories" class="tab-panel">
    <div class="table-card">
      <h3>Temps estime par categorie</h3>
      <table id="categoryTable">
        <thead><tr>
          <th data-sort="category">Categorie</th>
          <th data-sort="hours">Estime</th>
          <th data-sort="spent">Tracke</th>
          <th data-sort="pct">%</th>
          <th data-sort="tasks">Taches</th>
          <th data-sort="closedPct">Fermees</th>
          <th>Repartition</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- TAB: Projects -->
  <div id="panel-projects" class="tab-panel">
    <!-- List view -->
    <div id="projectListView">
      <div class="table-card">
        <h3>Temps estime par projet</h3>
        <table id="projectTable">
          <thead><tr>
            <th data-sort="project">Projet</th>
            <th data-sort="budget">Budget</th>
            <th data-sort="tempsVendu">Vendu (j)</th>
            <th data-sort="hours">Estime</th>
            <th data-sort="spent">Tracke</th>
            <th data-sort="budgetPct">Conso.</th>
            <th data-sort="tasks">Taches</th>
            <th data-sort="closedPct">Fermees</th>
            <th>Repartition</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="charts-grid">
        <div class="chart-card full">
          <h3>Heures estimees par projet et par mois (Top 10)</h3>
          <div class="chart-container h400"><canvas id="chartProjectMonthly"></canvas></div>
        </div>
      </div>
    </div>
    <!-- Detail view -->
    <div id="projectDetailView" style="display:none">
      <div class="project-detail-header">
        <button class="btn-back" onclick="clearProjectSelection()">&larr; Tous les projets</button>
        <h2 id="projectDetailTitle"></h2>
      </div>
      <div class="kpi-grid" id="projectDetailKpis"></div>
      <div id="projectDetailPrestations"></div>
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Estime vs Tracke par mois</h3>
          <div class="chart-container h300"><canvas id="chartProjectDetailMonthly"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>Repartition par consultant</h3>
          <div class="chart-container h300"><canvas id="chartProjectDetailConsultant"></canvas></div>
        </div>
      </div>
      <div class="table-card">
        <h3>Detail par mois et consultant</h3>
        <table id="projectDetailTable">
          <thead><tr>
            <th data-sort="month">Mois</th>
            <th data-sort="consultant">Consultant</th>
            <th data-sort="estimated">Estime</th>
            <th data-sort="tracked">Tracke</th>
            <th data-sort="tasks">Taches</th>
            <th data-sort="closedPct">Fermees</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB: Timeline -->
  <div id="panel-timeline" class="tab-panel">
    <div class="charts-grid">
      <div class="chart-card full">
        <h3>Heures estimees par semaine</h3>
        <div class="chart-container h300"><canvas id="chartWeekly"></canvas></div>
      </div>
      <div class="chart-card full">
        <h3>Repartition par jour de la semaine</h3>
        <div class="chart-container h300"><canvas id="chartDaily"></canvas></div>
      </div>
    </div>
    <div class="kpi-grid" id="timelineKpis"></div>
  </div>

  <!-- TAB: Detail -->
  <div id="panel-detail" class="tab-panel">
    <div class="table-card">
      <h3>Toutes les taches avec temps estime</h3>
      <div style="margin-bottom:12px">
        <input type="text" id="searchEntries" placeholder="Rechercher une tache ou un projet..."
          style="background:var(--bg);color:var(--text);border:1px solid var(--border);padding:8px 14px;border-radius:8px;width:100%;max-width:400px;font-size:14px;outline:none;">
      </div>
      <table id="detailTable">
        <thead><tr>
          <th data-sort="date">Date</th>
          <th data-sort="user">Consultant</th>
          <th data-sort="project">Projet</th>
          <th data-sort="task">Tache</th>
          <th data-sort="category">Categorie</th>
          <th data-sort="hours">Estime</th>
          <th data-sort="spent_hours">Tracke</th>
          <th data-sort="status">Statut</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div id="detailPagination" style="margin-top:12px;display:flex;gap:8px;align-items:center;"></div>
    </div>
  </div>

</div>

<script>
// ===== STATE =====
let FILTERED = [];
let selectedUser = '';
let selectedProject = '';
let sortState = {};
let detailPage = 0;
const PAGE_SIZE = 50;
const COLORS = [
  '#6366f1','#8b5cf6','#ec4899','#f43f5e','#f59e0b','#22c55e',
  '#06b6d4','#3b82f6','#a855f7','#14b8a6','#e879f9','#fb923c',
  '#84cc16','#64748b','#f97316','#0ea5e9','#d946ef','#fbbf24'
];
let charts = {};

// ===== INIT =====
document.addEventListener('DOMContentLoaded', function() {
  initTabs();
  initFilters();
  applyFilters();
});

// ===== TABS =====
function initTabs() {
  document.getElementById('tabBar').addEventListener('click', function(e) {
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    const tab = btn.dataset.tab;

    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

    btn.classList.add('active');
    document.getElementById('panel-' + tab).classList.add('active');
    renderCurrentTab(tab);
  });
}

function renderCurrentTab(tab) {
  if (tab === 'overview') { renderCategoryChart(); renderMonthlyChart(); renderCategoryMonthlyChart(); renderProjectChart(); renderEstVsTrackedChart(); }
  if (tab === 'categories') { renderCategoryTable(); }
  if (tab === 'projects') {
    if (selectedProject) { renderProjectDetailView(); } else { renderProjectListView(); }
  }
  if (tab === 'timeline') { renderWeeklyChart(); renderDailyChart(); renderTimelineKPIs(); }
  if (tab === 'detail') { renderDetailTable(); }
}

// ===== FILTERS =====
function initFilters() {
  const months = [...new Set(RAW_DATA.map(e => e.month))].sort();
  const users = [...new Set(RAW_DATA.map(e => e.user))].sort();

  document.getElementById('filterStart').value = months[0];
  document.getElementById('filterEnd').value = months[months.length - 1];

  const sel = document.getElementById('filterUser');
  // Sort users by total estimated hours descending
  const userHours = users.map(u => ({
    user: u,
    hours: RAW_DATA.filter(e => e.user === u).reduce((s, e) => s + e.hours, 0)
  })).sort((a, b) => b.hours - a.hours);

  userHours.forEach(({user, hours}) => {
    const opt = document.createElement('option');
    opt.value = user;
    opt.textContent = user + ' (' + Math.round(hours) + 'h)';
    sel.appendChild(opt);
  });

  // Populate category filter
  const catSel = document.getElementById('filterCategory');
  const categories = [...new Set(RAW_DATA.map(e => e.category))].sort();
  categories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    catSel.appendChild(opt);
  });

  // Populate project filter
  const projSel = document.getElementById('filterProject');
  const projectHours = [...new Set(RAW_DATA.map(e => e.project))].map(p => ({
    project: p,
    hours: RAW_DATA.filter(e => e.project === p).reduce((s, e) => s + e.hours, 0)
  })).sort((a, b) => b.hours - a.hours);
  projectHours.forEach(({project, hours}) => {
    const opt = document.createElement('option');
    opt.value = project;
    opt.textContent = cleanName(project) + ' (' + Math.round(hours) + 'h)';
    projSel.appendChild(opt);
  });

  document.getElementById('filterStart').addEventListener('change', applyFilters);
  document.getElementById('filterEnd').addEventListener('change', applyFilters);
  document.getElementById('filterCategory').addEventListener('change', applyFilters);
  document.getElementById('filterProject').addEventListener('change', function() {
    selectedProject = this.value;
    applyFilters();
  });
  document.getElementById('filterUser').addEventListener('change', function() {
    selectedUser = this.value;
    if (selectedUser) {
      const userMonths = [...new Set(RAW_DATA.filter(e => e.user === selectedUser).map(e => e.month))].sort();
      if (userMonths.length > 0) {
        document.getElementById('filterStart').value = userMonths[0];
        document.getElementById('filterEnd').value = userMonths[userMonths.length - 1];
      }
    } else {
      const allMonths = [...new Set(RAW_DATA.map(e => e.month))].sort();
      document.getElementById('filterStart').value = allMonths[0];
      document.getElementById('filterEnd').value = allMonths[allMonths.length - 1];
    }
    applyFilters();
  });
}

function applyFilters() {
  const startMonth = document.getElementById('filterStart').value;
  const endMonth = document.getElementById('filterEnd').value;
  const selectedCategory = document.getElementById('filterCategory').value;

  FILTERED = RAW_DATA.filter(e => {
    if (e.month < startMonth || e.month > endMonth) return false;
    if (selectedUser && e.user !== selectedUser) return false;
    if (selectedCategory && e.category !== selectedCategory) return false;
    if (selectedProject && e.project !== selectedProject) return false;
    return true;
  });

  const badge = document.getElementById('filterInfo');
  if (badge) {
    if (selectedUser && FILTERED.length === 0) {
      badge.textContent = 'Aucune donnee sur cette periode pour ce consultant';
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
    }
  }

  renderKPIs();
  Object.keys(charts).forEach(k => { if (charts[k]) { charts[k].destroy(); charts[k] = null; } });
  const activeTab = document.querySelector('.tab-btn.active');
  if (activeTab) renderCurrentTab(activeTab.dataset.tab);
}

// ===== KPIs =====
function renderKPIs() {
  const totalEstimated = FILTERED.reduce((s, e) => s + e.hours, 0);
  const totalTracked = FILTERED.reduce((s, e) => s + (e.spent_hours || 0), 0);
  const totalEntries = FILTERED.length;
  const closedEntries = FILTERED.filter(e => e.closed).length;
  const projects = new Set(FILTERED.map(e => e.project)).size;
  const months = new Set(FILTERED.map(e => e.month));
  const avgPerMonth = months.size > 0 ? totalEstimated / months.size : 0;
  const consultants = new Set(FILTERED.map(e => e.user)).size;
  const closedPct = totalEntries > 0 ? (closedEntries / totalEntries * 100) : 0;

  document.getElementById('kpiGrid').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-label">Temps estime total</div>
      <div class="kpi-value accent">${totalEstimated.toFixed(0)}h</div>
      <div class="kpi-sub">${totalEntries} taches</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Temps tracke</div>
      <div class="kpi-value">${totalTracked.toFixed(0)}h</div>
      <div class="kpi-sub">${totalTracked > 0 ? (totalTracked / totalEstimated * 100).toFixed(0) + '% de l\'estime' : 'non utilise'}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Moyenne / mois</div>
      <div class="kpi-value">${avgPerMonth.toFixed(0)}h</div>
      <div class="kpi-sub">${months.size} mois - ${consultants} consultant${consultants > 1 ? 's' : ''}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Projets</div>
      <div class="kpi-value">${projects}</div>
      <div class="kpi-sub">${(totalEstimated / (projects || 1)).toFixed(0)}h moy/projet</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Taux completion</div>
      <div class="kpi-value ${closedPct > 70 ? 'green' : 'orange'}">${closedPct.toFixed(0)}%</div>
      <div class="kpi-sub">${closedEntries}/${totalEntries} taches fermees</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Moy. par tache</div>
      <div class="kpi-value">${totalEntries > 0 ? (totalEstimated / totalEntries).toFixed(1) : 0}h</div>
      <div class="kpi-sub">estimation moyenne</div>
    </div>
  `;
}

// ===== CATEGORY COLORS (stable per category) =====
const CATEGORY_COLORS = {
  'Accompagnement SEO': '#6366f1',
  'Audit': '#f43f5e',
  'Brief / Roadmap / Strategie': '#8b5cf6',
  'Commercial / Avant-vente': '#f59e0b',
  'Conges / Absences': '#64748b',
  'Etude lexicale': '#06b6d4',
  'Formation': '#a855f7',
  'Gestion / Planning': '#fb923c',
  'Maillage interne': '#14b8a6',
  'Netlinking': '#84cc16',
  'Operationnel client': '#e879f9',
  'Redaction / Contenu': '#3b82f6',
  'Reporting / Analytics': '#22c55e',
  'Reunion / Call / Email': '#ec4899',
  'Technique': '#0ea5e9',
  'Autre': '#94a3b8',
};

function getCategoryColor(cat) {
  return CATEGORY_COLORS[cat] || COLORS[Object.keys(CATEGORY_COLORS).length % COLORS.length];
}

// ===== CATEGORY DONUT =====
function renderCategoryChart() {
  if (charts.categories) { charts.categories.destroy(); charts.categories = null; }
  if (FILTERED.length === 0) return;
  const byCat = {};
  FILTERED.forEach(e => { byCat[e.category] = (byCat[e.category] || 0) + e.hours; });

  const sorted = Object.entries(byCat).sort((a, b) => b[1] - a[1]);
  const labels = sorted.map(([c]) => c);
  const values = sorted.map(([, h]) => round1(h));
  const colors = sorted.map(([c]) => getCategoryColor(c));
  const total = values.reduce((a, b) => a + b, 0);

  charts.categories = new Chart(document.getElementById('chartCategories'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { color: '#8b8d98', font: { size: 11 }, padding: 6, boxWidth: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.label + ': ' + ctx.parsed + 'h (' + (ctx.parsed / total * 100).toFixed(1) + '%)' } }
      }
    }
  });
}

// ===== CATEGORY x MONTH STACKED =====
function renderCategoryMonthlyChart() {
  if (charts.categoryMonthly) { charts.categoryMonthly.destroy(); charts.categoryMonthly = null; }
  if (FILTERED.length === 0) return;
  const byCM = {};
  const allMonths = new Set();
  FILTERED.forEach(e => {
    if (!byCM[e.category]) byCM[e.category] = {};
    byCM[e.category][e.month] = (byCM[e.category][e.month] || 0) + e.hours;
    allMonths.add(e.month);
  });
  const months = [...allMonths].sort();

  // Sort categories by total hours descending
  const catTotals = Object.entries(byCM)
    .map(([c, m]) => [c, Object.values(m).reduce((a, b) => a + b, 0)])
    .sort((a, b) => b[1] - a[1]);
  const catNames = catTotals.map(([c]) => c);

  const datasets = catNames.map(c => ({
    label: c,
    data: months.map(m => round1(byCM[c][m] || 0)),
    backgroundColor: getCategoryColor(c),
    borderRadius: 2, borderSkipped: false
  }));

  charts.categoryMonthly = new Chart(document.getElementById('chartCategoryMonthly'), {
    type: 'bar',
    data: { labels: months.map(fmtMonth), datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { stacked: true, grid: { display: false }, ticks: { color: '#8b8d98' } },
        y: { stacked: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b8d98', callback: v => v + 'h' } }
      },
      plugins: {
        legend: { position: 'bottom', labels: { color: '#8b8d98', font: { size: 10 }, padding: 8, boxWidth: 10 } },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + 'h' } }
      }
    }
  });
}

// ===== CATEGORY TABLE =====
function renderCategoryTable() {
  const byCat = {};
  FILTERED.forEach(e => {
    if (!byCat[e.category]) byCat[e.category] = { hours: 0, spent: 0, tasks: 0, closed: 0 };
    byCat[e.category].hours += e.hours;
    byCat[e.category].spent += (e.spent_hours || 0);
    byCat[e.category].tasks++;
    if (e.closed) byCat[e.category].closed++;
  });
  const totalH = FILTERED.reduce((s, e) => s + e.hours, 0);
  let rows = Object.entries(byCat).map(([category, d]) => ({
    category, hours: d.hours, spent: d.spent,
    pct: totalH > 0 ? d.hours / totalH * 100 : 0,
    tasks: d.tasks, closedPct: d.tasks > 0 ? d.closed / d.tasks * 100 : 0
  }));
  const sort = sortState.categoryTable || { col: 'hours', dir: 'desc' };
  rows.sort((a, b) => {
    const va = a[sort.col], vb = b[sort.col];
    const cmp = typeof va === 'string' ? va.localeCompare(vb) : va - vb;
    return sort.dir === 'asc' ? cmp : -cmp;
  });
  const maxH = Math.max(...rows.map(r => r.hours), 1);
  document.querySelector('#categoryTable tbody').innerHTML = rows.map(r => `<tr>
    <td><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${getCategoryColor(r.category)};margin-right:8px;vertical-align:middle"></span>${esc(r.category)}</td>
    <td><strong>${r.hours.toFixed(1)}h</strong></td>
    <td>${r.spent.toFixed(1)}h</td>
    <td>${r.pct.toFixed(1)}%</td>
    <td>${r.tasks}</td>
    <td><span class="badge ${r.closedPct > 70 ? 'badge-closed' : 'badge-open'}">${r.closedPct.toFixed(0)}%</span></td>
    <td><div class="mini-bar"><div class="mini-bar-fill" style="width:${r.hours/maxH*100}%;background:${getCategoryColor(r.category)}"></div></div></td>
  </tr>`).join('');
  updateSortIndicators('categoryTable', sort);
}

// ===== PROJECT DONUT =====
function renderProjectChart() {
  if (charts.projects) { charts.projects.destroy(); charts.projects = null; }
  if (FILTERED.length === 0) return;
  const byProject = {};
  FILTERED.forEach(e => { byProject[e.project] = (byProject[e.project] || 0) + e.hours; });

  const sorted = Object.entries(byProject).sort((a, b) => b[1] - a[1]);
  const top = sorted.slice(0, 12);
  const otherH = sorted.slice(12).reduce((s, [, h]) => s + h, 0);
  if (otherH > 0) top.push(['Autres', otherH]);

  const labels = top.map(([p]) => cleanName(p));
  const values = top.map(([, h]) => round1(h));
  const total = values.reduce((a, b) => a + b, 0);

  charts.projects = new Chart(document.getElementById('chartProjects'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: COLORS.slice(0, labels.length), borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { color: '#8b8d98', font: { size: 11 }, padding: 8, boxWidth: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.label + ': ' + ctx.parsed + 'h (' + (ctx.parsed / total * 100).toFixed(1) + '%)' } }
      }
    }
  });
}

// ===== MONTHLY BAR =====
function renderMonthlyChart() {
  if (charts.monthly) { charts.monthly.destroy(); charts.monthly = null; }
  if (FILTERED.length === 0) return;
  const byMonth = {};
  FILTERED.forEach(e => { byMonth[e.month] = (byMonth[e.month] || 0) + e.hours; });
  const months = Object.keys(byMonth).sort();
  const values = months.map(m => round1(byMonth[m]));
  const avg = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;

  // Capacite reelle par mois (jours ouvres * 7h)
  const capas = months.map(m => capaciteMois(m));
  const obj80 = capas.map(c => round1(c * 0.8));

  const datasets = [
    { label: 'Estime', data: values, backgroundColor: 'rgba(99,102,241,0.7)', borderRadius: 6, borderSkipped: false },
    { label: 'Moyenne', data: Array(months.length).fill(Math.round(avg)), type: 'line', borderColor: '#f59e0b', borderDash: [6, 4], pointRadius: 0, borderWidth: 2, fill: false }
  ];

  if (selectedUser) {
    datasets.push({
      label: 'Objectif 80%',
      data: obj80,
      type: 'line', borderColor: '#22c55e', borderDash: [6, 4], pointRadius: 0, borderWidth: 2, fill: false
    });
    datasets.push({
      label: 'Capacite 35h/sem',
      data: capas,
      type: 'line', borderColor: '#ef4444', borderDash: [2, 3], pointRadius: 0, borderWidth: 2, fill: false
    });
  }

  // Store capas for tooltip
  const monthCapas = {};
  months.forEach((m, i) => { monthCapas[i] = capas[i]; });

  charts.monthly = new Chart(document.getElementById('chartMonthly'), {
    type: 'bar',
    data: { labels: months.map(fmtMonth), datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: '#8b8d98' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b8d98', callback: v => v + 'h' } }
      },
      plugins: {
        legend: { labels: { color: '#8b8d98', font: { size: 11 }, boxWidth: 12, padding: 12 } },
        tooltip: { callbacks: { label: ctx => {
          if (ctx.dataset.type === 'line' || ctx.datasetIndex > 0) return ctx.dataset.label + ': ' + ctx.parsed.y + 'h';
          const capa = monthCapas[ctx.dataIndex] || 151;
          const pct = (ctx.parsed.y / capa * 100).toFixed(0);
          return ctx.dataset.label + ': ' + ctx.parsed.y + 'h / ' + capa + 'h (' + pct + '%)';
        }}}
      }
    }
  });
}

// ===== ESTIMATED vs TRACKED =====
function renderEstVsTrackedChart() {
  if (charts.estVsTracked) { charts.estVsTracked.destroy(); charts.estVsTracked = null; }
  if (FILTERED.length === 0) return;
  const byMonthEst = {};
  const byMonthSpent = {};
  FILTERED.forEach(e => {
    byMonthEst[e.month] = (byMonthEst[e.month] || 0) + e.hours;
    byMonthSpent[e.month] = (byMonthSpent[e.month] || 0) + (e.spent_hours || 0);
  });
  const months = [...new Set([...Object.keys(byMonthEst), ...Object.keys(byMonthSpent)])].sort();
  const estValues = months.map(m => round1(byMonthEst[m] || 0));
  const spentValues = months.map(m => round1(byMonthSpent[m] || 0));

  charts.estVsTracked = new Chart(document.getElementById('chartEstVsTracked'), {
    type: 'bar',
    data: {
      labels: months.map(fmtMonth),
      datasets: [
        { label: 'Temps estime', data: estValues, backgroundColor: 'rgba(99,102,241,0.7)', borderRadius: 6, borderSkipped: false },
        { label: 'Temps tracke', data: spentValues, backgroundColor: 'rgba(34,197,94,0.5)', borderRadius: 6, borderSkipped: false }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: '#8b8d98' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b8d98', callback: v => v + 'h' } }
      },
      plugins: {
        legend: { labels: { color: '#8b8d98', font: { size: 11 }, boxWidth: 12, padding: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + 'h' } }
      }
    }
  });
}

// ===== BUDGET HELPERS =====
const DEFAULT_TJM = 690;
function getProjectBudget(projectName) {
  if (typeof PROJECT_BUDGETS === 'undefined') return null;
  return PROJECT_BUDGETS[projectName] || null;
}
function fmtEur(n) { return n.toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' \u20ac'; }

// ===== PROJECT TABLE =====
function renderProjectTable() {
  const byProject = {};
  FILTERED.forEach(e => {
    if (!byProject[e.project]) byProject[e.project] = { hours: 0, spent: 0, tasks: 0, closed: 0 };
    byProject[e.project].hours += e.hours;
    byProject[e.project].spent += (e.spent_hours || 0);
    byProject[e.project].tasks++;
    if (e.closed) byProject[e.project].closed++;
  });
  const totalH = FILTERED.reduce((s, e) => s + e.hours, 0);
  let rows = Object.entries(byProject).map(([project, d]) => {
    const b = getProjectBudget(project);
    const budget = b ? b.budget : 0;
    const tempsVendu = b ? b.temps_vendu_jours : 0;
    const tjm = b ? b.tjm : DEFAULT_TJM;
    const tempsVenduH = tempsVendu * 7;
    const budgetPct = tempsVenduH > 0 ? (d.spent / tempsVenduH * 100) : 0;
    return {
      project, hours: d.hours, spent: d.spent,
      pct: totalH > 0 ? d.hours / totalH * 100 : 0,
      tasks: d.tasks, closedPct: d.tasks > 0 ? d.closed / d.tasks * 100 : 0,
      budget, tempsVendu, tjm, budgetPct
    };
  });
  const sort = sortState.projectTable || { col: 'hours', dir: 'desc' };
  rows.sort((a, b) => {
    const va = a[sort.col], vb = b[sort.col];
    const cmp = typeof va === 'string' ? va.localeCompare(vb) : va - vb;
    return sort.dir === 'asc' ? cmp : -cmp;
  });
  const maxH = Math.max(...rows.map(r => r.hours), 1);
  document.querySelector('#projectTable tbody').innerHTML = rows.map(r => {
    const budgetCell = r.budget > 0 ? `<strong>${fmtEur(r.budget)}</strong>` : '<span style="color:var(--text-dim)">-</span>';
    const venduCell = r.tempsVendu > 0 ? `${r.tempsVendu}j` : '<span style="color:var(--text-dim)">-</span>';
    const consoColor = r.budgetPct > 100 ? 'var(--red)' : r.budgetPct > 80 ? 'var(--orange)' : 'var(--green)';
    const consoCell = r.tempsVendu > 0 ? `<span style="color:${consoColor};font-weight:600">${r.budgetPct.toFixed(0)}%</span>` : '<span style="color:var(--text-dim)">-</span>';
    return `<tr class="clickable-row" data-project="${esc(r.project)}">
    <td>${cleanName(r.project)}</td>
    <td>${budgetCell}</td>
    <td>${venduCell}</td>
    <td><strong>${r.hours.toFixed(1)}h</strong></td>
    <td>${r.spent.toFixed(1)}h</td>
    <td>${consoCell}</td>
    <td>${r.tasks}</td>
    <td><span class="badge ${r.closedPct > 70 ? 'badge-closed' : 'badge-open'}">${r.closedPct.toFixed(0)}%</span></td>
    <td><div class="mini-bar"><div class="mini-bar-fill" style="width:${r.hours/maxH*100}%"></div></div></td>
  </tr>`;
  }).join('');
  updateSortIndicators('projectTable', sort);
}

// ===== PROJECT x MONTH STACKED =====
function renderProjectMonthlyChart() {
  if (charts.projectMonthly) { charts.projectMonthly.destroy(); charts.projectMonthly = null; }
  if (FILTERED.length === 0) return;
  const byPM = {};
  const allMonths = new Set();
  FILTERED.forEach(e => {
    if (!byPM[e.project]) byPM[e.project] = {};
    byPM[e.project][e.month] = (byPM[e.project][e.month] || 0) + e.hours;
    allMonths.add(e.month);
  });
  const months = [...allMonths].sort();
  const topProjects = Object.entries(byPM)
    .map(([p, m]) => [p, Object.values(m).reduce((a, b) => a + b, 0)])
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(([p]) => p);

  const datasets = topProjects.map((p, i) => ({
    label: cleanName(p),
    data: months.map(m => round1(byPM[p][m] || 0)),
    backgroundColor: COLORS[i % COLORS.length],
    borderRadius: 4, borderSkipped: false
  }));

  charts.projectMonthly = new Chart(document.getElementById('chartProjectMonthly'), {
    type: 'bar',
    data: { labels: months.map(fmtMonth), datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { stacked: true, grid: { display: false }, ticks: { color: '#8b8d98' } },
        y: { stacked: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b8d98', callback: v => v + 'h' } }
      },
      plugins: {
        legend: { position: 'bottom', labels: { color: '#8b8d98', font: { size: 11 }, padding: 12, boxWidth: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + 'h' } }
      }
    }
  });
}

// ===== WEEKLY =====
function renderWeeklyChart() {
  if (charts.weekly) { charts.weekly.destroy(); charts.weekly = null; }
  if (FILTERED.length === 0) return;
  const byWeek = {};
  FILTERED.forEach(e => { byWeek[e.week] = (byWeek[e.week] || 0) + e.hours; });
  const weeks = Object.keys(byWeek).sort();
  const values = weeks.map(w => round1(byWeek[w]));

  charts.weekly = new Chart(document.getElementById('chartWeekly'), {
    type: 'line',
    data: {
      labels: weeks.map(w => w.replace(/^\d{4}-/, '')),
      datasets: [{
        label: 'Heures estimees', data: values,
        borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)',
        fill: true, tension: 0.3, pointRadius: 2, pointBackgroundColor: '#6366f1'
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: '#8b8d98', maxTicksLimit: 20 } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b8d98', callback: v => v + 'h' } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

// ===== DAILY =====
function renderDailyChart() {
  if (charts.daily) { charts.daily.destroy(); charts.daily = null; }
  if (FILTERED.length === 0) return;
  const dayNames = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
  const byDay = [0,0,0,0,0,0,0];
  const countDay = [0,0,0,0,0,0,0];
  FILTERED.forEach(e => { const d = new Date(e.date).getDay(); byDay[d] += e.hours; countDay[d]++; });
  const order = [1,2,3,4,5,6,0];
  const labels = order.map(i => dayNames[i]);
  const totalValues = order.map(i => round1(byDay[i]));
  const avgValues = order.map(i => countDay[i] > 0 ? round1(byDay[i] / countDay[i]) : 0);

  charts.daily = new Chart(document.getElementById('chartDaily'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Total', data: totalValues, backgroundColor: 'rgba(99,102,241,0.6)', borderRadius: 6, borderSkipped: false, yAxisID: 'y' },
        { label: 'Moy/jour', data: avgValues, type: 'line', borderColor: '#22c55e', pointBackgroundColor: '#22c55e', pointRadius: 5, borderWidth: 2, fill: false, yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: '#8b8d98' } },
        y: { position: 'left', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b8d98', callback: v => v + 'h' }, title: { display: true, text: 'Total', color: '#8b8d98' } },
        y1: { position: 'right', grid: { display: false }, ticks: { color: '#22c55e', callback: v => v + 'h' }, title: { display: true, text: 'Moy/jour', color: '#22c55e' } }
      },
      plugins: { legend: { labels: { color: '#8b8d98' } } }
    }
  });
}

// ===== TIMELINE KPIs =====
function renderTimelineKPIs() {
  const byWeek = {};
  FILTERED.forEach(e => { byWeek[e.week] = (byWeek[e.week] || 0) + e.hours; });
  const wv = Object.values(byWeek);
  const avgW = wv.length > 0 ? wv.reduce((a, b) => a + b, 0) / wv.length : 0;
  const maxW = wv.length > 0 ? Math.max(...wv) : 0;
  const minW = wv.length > 0 ? Math.min(...wv) : 0;

  const closedTasks = FILTERED.filter(e => e.closed).length;
  const totalTasks = FILTERED.length;

  document.getElementById('timelineKpis').innerHTML = `
    <div class="kpi-card"><div class="kpi-label">Moy. heures/semaine</div><div class="kpi-value">${avgW.toFixed(1)}h</div></div>
    <div class="kpi-card"><div class="kpi-label">Semaine max</div><div class="kpi-value">${maxW.toFixed(1)}h</div></div>
    <div class="kpi-card"><div class="kpi-label">Semaine min</div><div class="kpi-value">${minW.toFixed(1)}h</div></div>
    <div class="kpi-card"><div class="kpi-label">Taches fermees</div><div class="kpi-value green">${closedTasks}</div><div class="kpi-sub">sur ${totalTasks} total</div></div>
  `;
}

// ===== DETAIL TABLE =====
function renderDetailTable() {
  let data = [...FILTERED];
  const search = (document.getElementById('searchEntries').value || '').toLowerCase();
  if (search) data = data.filter(e => e.task.toLowerCase().includes(search) || e.project.toLowerCase().includes(search) || e.category.toLowerCase().includes(search));

  const sort = sortState.detailTable || { col: 'date', dir: 'desc' };
  data.sort((a, b) => {
    const va = a[sort.col], vb = b[sort.col];
    const cmp = typeof va === 'string' ? va.localeCompare(vb) : va - vb;
    return sort.dir === 'asc' ? cmp : -cmp;
  });

  const total = data.length;
  const pages = Math.ceil(total / PAGE_SIZE) || 1;
  detailPage = Math.max(0, Math.min(detailPage, pages - 1));
  const slice = data.slice(detailPage * PAGE_SIZE, (detailPage + 1) * PAGE_SIZE);

  document.querySelector('#detailTable tbody').innerHTML = slice.map(e => `<tr>
    <td>${e.date}</td>
    <td>${esc(e.user)}</td>
    <td>${cleanName(e.project)}</td>
    <td>${esc(e.task)}</td>
    <td><span style="color:${getCategoryColor(e.category)};font-size:12px">${esc(e.category)}</span></td>
    <td><strong>${e.hours.toFixed(1)}h</strong></td>
    <td>${(e.spent_hours || 0).toFixed(1)}h</td>
    <td><span class="badge ${e.closed ? 'badge-closed' : 'badge-open'}">${e.closed ? 'Fermee' : 'Ouverte'}</span></td>
  </tr>`).join('');

  const bs = 'background:var(--card);color:var(--text);border:1px solid var(--border);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:13px;';
  document.getElementById('detailPagination').innerHTML = `
    <span style="color:var(--text-dim);font-size:13px">${total} taches</span>
    <button style="${bs}" onclick="detailPage=0;renderDetailTable()" ${detailPage===0?'disabled':''}>&#171;</button>
    <button style="${bs}" onclick="detailPage--;renderDetailTable()" ${detailPage===0?'disabled':''}>&#8249;</button>
    <span style="color:var(--text);font-size:13px">Page ${detailPage+1}/${pages}</span>
    <button style="${bs}" onclick="detailPage++;renderDetailTable()" ${detailPage>=pages-1?'disabled':''}>&#8250;</button>
    <button style="${bs}" onclick="detailPage=${pages-1};renderDetailTable()" ${detailPage>=pages-1?'disabled':''}>&#187;</button>
  `;

  updateSortIndicators('detailTable', sort);
}

// ===== TABLE SORTING =====
document.addEventListener('click', function(e) {
  const clickableRow = e.target.closest('tr.clickable-row[data-project]');
  if (clickableRow && !e.target.closest('th')) {
    selectProject(clickableRow.dataset.project);
    return;
  }
  const th = e.target.closest('th[data-sort]');
  if (!th) return;
  const tableId = th.closest('table').id;
  const col = th.dataset.sort;
  const cur = sortState[tableId] || {};
  sortState[tableId] = { col, dir: cur.col === col && cur.dir === 'desc' ? 'asc' : 'desc' };
  if (tableId === 'categoryTable') renderCategoryTable();
  if (tableId === 'projectTable') renderProjectTable();
  if (tableId === 'projectDetailTable') renderProjectDetailTable(FILTERED);
  if (tableId === 'detailTable') { detailPage = 0; renderDetailTable(); }
});

document.getElementById('searchEntries').addEventListener('input', function() { detailPage = 0; renderDetailTable(); });

// ===== HELPERS =====
function updateSortIndicators(tableId, sort) {
  document.querySelectorAll('#' + tableId + ' th').forEach(th => {
    th.classList.remove('sorted-asc', 'sorted-desc');
    if (th.dataset.sort === sort.col) th.classList.add('sorted-' + sort.dir);
  });
}

function cleanName(name) {
  return name.replace(/^[\p{So}\p{Sk}\u200D\uFE0F\u{13A29}\u{13A2A}\u2660-\u2667\uFE0E\uFE0F]*\s*/u, '').trim() || name;
}

function fmtMonth(m) {
  const names = ['Jan','Fev','Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec'];
  const [y, mo] = m.split('-');
  return names[parseInt(mo) - 1] + ' ' + y.slice(2);
}

function round1(n) { return Math.round(n * 10) / 10; }
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function joursOuvres(monthStr) {
  // Jours de semaine (lun-ven) sans feries, comme ClickUp
  const [y, m] = monthStr.split('-').map(Number);
  const daysInMonth = new Date(y, m, 0).getDate();
  let count = 0;
  for (let d = 1; d <= daysInMonth; d++) {
    const dow = new Date(y, m - 1, d).getDay();
    if (dow !== 0 && dow !== 6) count++;
  }
  return count;
}

function capaciteMois(monthStr) {
  return joursOuvres(monthStr) * 7; // 7h/jour = 35h/semaine
}

// ===== PROJECT SELECTION =====
function selectProject(name) {
  selectedProject = name;
  document.getElementById('filterProject').value = name;
  applyFilters();
  // Switch to projects tab if not already
  const projBtn = document.querySelector('.tab-btn[data-tab="projects"]');
  if (projBtn && !projBtn.classList.contains('active')) {
    projBtn.click();
  }
}

function clearProjectSelection() {
  selectedProject = '';
  document.getElementById('filterProject').value = '';
  applyFilters();
}

function renderProjectListView() {
  document.getElementById('projectListView').style.display = '';
  document.getElementById('projectDetailView').style.display = 'none';
  renderProjectTable();
  renderProjectMonthlyChart();
}

function renderProjectDetailView() {
  document.getElementById('projectListView').style.display = 'none';
  document.getElementById('projectDetailView').style.display = '';
  document.getElementById('projectDetailTitle').textContent = cleanName(selectedProject);

  const projData = FILTERED; // already filtered to selectedProject

  // KPIs
  const totalEst = projData.reduce((s, e) => s + e.hours, 0);
  const totalTracked = projData.reduce((s, e) => s + (e.spent_hours || 0), 0);
  const months = new Set(projData.map(e => e.month));
  const consultants = new Set(projData.map(e => e.user));
  const closedCount = projData.filter(e => e.closed).length;
  const closedPct = projData.length > 0 ? (closedCount / projData.length * 100) : 0;
  const completion = totalEst > 0 ? (totalTracked / totalEst * 100) : 0;

  // Budget
  const b = getProjectBudget(selectedProject);
  const budget = b ? b.budget : 0;
  const tempsVendu = b ? b.temps_vendu_jours : 0;
  const tjm = b ? b.tjm : DEFAULT_TJM;
  const tempsVenduH = tempsVendu * 7;
  const budgetConsomme = totalTracked / 7 * tjm;
  const budgetRestant = budget - budgetConsomme;
  const budgetPct = budget > 0 ? (budgetConsomme / budget * 100) : 0;
  const tempsPct = tempsVenduH > 0 ? (totalTracked / tempsVenduH * 100) : 0;

  let budgetKpis = '';
  if (budget > 0 || tempsVendu > 0) {
    const consoColor = tempsPct > 100 ? 'red' : tempsPct > 80 ? 'orange' : 'green';
    const budgetColor = budgetPct > 100 ? 'red' : budgetPct > 80 ? 'orange' : 'green';
    budgetKpis = `
    <div class="kpi-card">
      <div class="kpi-label">Budget</div>
      <div class="kpi-value accent">${fmtEur(budget)}</div>
      <div class="kpi-sub">TJM ${fmtEur(tjm)}${b && b.tjm !== DEFAULT_TJM ? '' : ' (defaut)'}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Temps vendu</div>
      <div class="kpi-value">${tempsVendu}j</div>
      <div class="kpi-sub">${tempsVenduH.toFixed(0)}h (${tempsVendu}j x 7h)</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Conso. temps</div>
      <div class="kpi-value ${consoColor}">${tempsPct.toFixed(0)}%</div>
      <div class="kpi-sub">${totalTracked.toFixed(1)}h trackees / ${tempsVenduH.toFixed(0)}h vendues</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Budget restant</div>
      <div class="kpi-value ${budgetColor}">${fmtEur(budgetRestant)}</div>
      <div class="kpi-sub">${fmtEur(budgetConsomme)} consomme (${budgetPct.toFixed(0)}%)</div>
    </div>`;
  }

  document.getElementById('projectDetailKpis').innerHTML = `
    ${budgetKpis}
    <div class="kpi-card">
      <div class="kpi-label">Heures estimees</div>
      <div class="kpi-value accent">${totalEst.toFixed(1)}h</div>
      <div class="kpi-sub">${projData.length} taches</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Heures trackees</div>
      <div class="kpi-value">${totalTracked.toFixed(1)}h</div>
      <div class="kpi-sub">${completion.toFixed(0)}% du temps estime</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Mois actifs</div>
      <div class="kpi-value">${months.size}</div>
      <div class="kpi-sub">${(totalEst / (months.size || 1)).toFixed(0)}h/mois en moyenne</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Consultants</div>
      <div class="kpi-value">${consultants.size}</div>
      <div class="kpi-sub">${[...consultants].join(', ')}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Taux completion</div>
      <div class="kpi-value ${closedPct > 70 ? 'green' : 'orange'}">${closedPct.toFixed(0)}%</div>
      <div class="kpi-sub">${closedCount}/${projData.length} taches fermees</div>
    </div>
  `;

  // Prestations vendues
  const prestaEl = document.getElementById('projectDetailPrestations');
  if (b && b.prestations && b.prestations.length > 0) {
    const TYPE_COLORS = {
      'Accompagnement': '#6366f1',
      'Audit stratgique': '#f43f5e',
      'Audit technique': '#ef4444',
      'Rdaction contenu': '#3b82f6',
      'Reporting': '#22c55e',
      'Gestion de projets': '#f59e0b',
      'Roadmap': '#8b5cf6',
      'AMOA': '#06b6d4',
      'Recette': '#14b8a6',
      'Redirections': '#fb923c',
      'Netlinking': '#84cc16',
    };
    const tags = b.prestations.map(p => {
      const col = TYPE_COLORS[p.type_prestation] || '#64748b';
      const typeTag = p.type_prestation ? `<span class="presta-type" style="background:${col}22;color:${col}">${esc(p.type_prestation)}</span>` : '';
      const jours = p.temps_vendu_jours > 0 ? p.temps_vendu_jours + 'j' : '';
      const euros = p.budget > 0 ? fmtEur(p.budget) : '';
      const meta = [jours, euros].filter(Boolean).join('  ');
      return `<div class="presta-tag">${typeTag}<span class="presta-name">${esc(p.list_name)}</span>${meta ? `<span class="presta-meta">${meta}</span>` : ''}</div>`;
    }).join('');
    prestaEl.innerHTML = `<div class="prestations-card"><h3>Prestations vendues</h3><div class="prestations-grid">${tags}</div></div>`;
  } else {
    prestaEl.innerHTML = '';
  }

  renderProjectDetailMonthlyChart(projData);
  renderProjectDetailConsultantChart(projData);
  renderProjectDetailTable(projData);
}

function renderProjectDetailMonthlyChart(projData) {
  if (charts.projectDetailMonthly) { charts.projectDetailMonthly.destroy(); charts.projectDetailMonthly = null; }
  if (projData.length === 0) return;

  const byMonthEst = {};
  const byMonthSpent = {};
  projData.forEach(e => {
    byMonthEst[e.month] = (byMonthEst[e.month] || 0) + e.hours;
    byMonthSpent[e.month] = (byMonthSpent[e.month] || 0) + (e.spent_hours || 0);
  });
  const months = [...new Set([...Object.keys(byMonthEst), ...Object.keys(byMonthSpent)])].sort();

  const datasets = [
    { label: 'Estime', data: months.map(m => round1(byMonthEst[m] || 0)), backgroundColor: 'rgba(99,102,241,0.7)', borderRadius: 6, borderSkipped: false },
    { label: 'Tracke', data: months.map(m => round1(byMonthSpent[m] || 0)), backgroundColor: 'rgba(34,197,94,0.5)', borderRadius: 6, borderSkipped: false }
  ];

  // Add "temps vendu moyen/mois" reference line if budget exists
  const b = getProjectBudget(selectedProject);
  if (b && b.temps_vendu_jours > 0 && months.length > 0) {
    const avgPerMonth = round1(b.temps_vendu_jours * 7 / months.length);
    datasets.push({
      label: 'Moy. vendu/mois (' + avgPerMonth + 'h)',
      data: Array(months.length).fill(avgPerMonth),
      type: 'line', borderColor: '#f59e0b', borderDash: [6, 4], pointRadius: 0, borderWidth: 2, fill: false
    });
  }

  charts.projectDetailMonthly = new Chart(document.getElementById('chartProjectDetailMonthly'), {
    type: 'bar',
    data: { labels: months.map(fmtMonth), datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: '#8b8d98' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b8d98', callback: v => v + 'h' } }
      },
      plugins: {
        legend: { labels: { color: '#8b8d98', font: { size: 11 }, boxWidth: 12, padding: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + 'h' } }
      }
    }
  });
}

function renderProjectDetailConsultantChart(projData) {
  if (charts.projectDetailConsultant) { charts.projectDetailConsultant.destroy(); charts.projectDetailConsultant = null; }
  if (projData.length === 0) return;

  const byConsultant = {};
  projData.forEach(e => { byConsultant[e.user] = (byConsultant[e.user] || 0) + e.hours; });
  const sorted = Object.entries(byConsultant).sort((a, b) => b[1] - a[1]);
  const labels = sorted.map(([u]) => u);
  const values = sorted.map(([, h]) => round1(h));
  const total = values.reduce((a, b) => a + b, 0);

  charts.projectDetailConsultant = new Chart(document.getElementById('chartProjectDetailConsultant'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: COLORS.slice(0, labels.length), borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { color: '#8b8d98', font: { size: 11 }, padding: 8, boxWidth: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.label + ': ' + ctx.parsed + 'h (' + (ctx.parsed / total * 100).toFixed(1) + '%)' } }
      }
    }
  });
}

function renderProjectDetailTable(projData) {
  const byMC = {};
  projData.forEach(e => {
    const key = e.month + '|||' + e.user;
    if (!byMC[key]) byMC[key] = { month: e.month, consultant: e.user, estimated: 0, tracked: 0, tasks: 0, closed: 0 };
    byMC[key].estimated += e.hours;
    byMC[key].tracked += (e.spent_hours || 0);
    byMC[key].tasks++;
    if (e.closed) byMC[key].closed++;
  });

  let rows = Object.values(byMC).map(r => ({
    ...r,
    closedPct: r.tasks > 0 ? r.closed / r.tasks * 100 : 0
  }));

  const sort = sortState.projectDetailTable || { col: 'month', dir: 'desc' };
  rows.sort((a, b) => {
    const va = a[sort.col], vb = b[sort.col];
    const cmp = typeof va === 'string' ? va.localeCompare(vb) : va - vb;
    return sort.dir === 'asc' ? cmp : -cmp;
  });

  document.querySelector('#projectDetailTable tbody').innerHTML = rows.map(r => `<tr>
    <td>${fmtMonth(r.month)}</td>
    <td>${esc(r.consultant)}</td>
    <td><strong>${r.estimated.toFixed(1)}h</strong></td>
    <td>${r.tracked.toFixed(1)}h</td>
    <td>${r.tasks}</td>
    <td><span class="badge ${r.closedPct > 70 ? 'badge-closed' : 'badge-open'}">${r.closedPct.toFixed(0)}%</span></td>
  </tr>`).join('');

  updateSortIndicators('projectDetailTable', sort);
}
</script>
</body>
</html>
